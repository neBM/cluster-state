stages:
  - validate
  - plan
  - apply

variables:
  TF_IN_AUTOMATION: "true"
  ACT_IMAGE: ${CI_REGISTRY}/ben/act:latest

.terraform-base:
  image: ${ACT_IMAGE}
  cache:
    key: terraform-plugins
    paths:
      - .terraform/providers
  before_script:
    # Setup kubeconfig using ServiceAccount token (limited RBAC)
    # Required CI variables: K8S_HOST, K8S_TOKEN, K8S_CA_CERT
    # Write to ~/.kube/k3s-config to match provider config_path
    - mkdir -p ~/.kube
    - |
      cat > ~/.kube/k3s-config << EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: k3s
        cluster:
          server: ${K8S_HOST}
          certificate-authority-data: ${K8S_CA_CERT}
      contexts:
      - name: default
        context:
          cluster: k3s
          user: terraform-ci
      current-context: default
      users:
      - name: terraform-ci
        user:
          token: ${K8S_TOKEN}
      EOF
    - chmod 600 ~/.kube/k3s-config

validate:
  extends: .terraform-base
  stage: validate
  script:
    # Format check - no backend required
    - terraform fmt -check -recursive
    # Validate with -backend=false (no credentials needed)
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

plan:
  extends: .terraform-base
  stage: plan
  script:
    - terraform init -backend-config="conn_str=$PG_CONN_STR"
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - tfplan
      - .terraform
      - .terraform.lock.hcl
    expire_in: 1 hour
  rules:
    # Only run on main branch where protected variables are available
    - if: $CI_COMMIT_BRANCH == "main"

apply:
  extends: .terraform-base
  stage: apply
  dependencies:
    - plan
  script:
    - terraform init -backend-config="conn_str=$PG_CONN_STR"
    - terraform apply -auto-approve
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: production
