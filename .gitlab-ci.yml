stages:
  - validate
  - plan
  - apply

variables:
  TF_IN_AUTOMATION: "true"

.terraform-base:
  image: debian:bookworm-slim
  cache:
    key: terraform-plugins
    paths:
      - .terraform/providers
  before_script:
    - apt-get update && apt-get install -y curl unzip gnupg
    # Install Terraform from HashiCorp repos
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
    - echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com bookworm main" > /etc/apt/sources.list.d/hashicorp.list
    - apt-get update && apt-get install -y terraform
    # Setup kubeconfig using ServiceAccount token (limited RBAC)
    # Required CI variables: K8S_HOST, K8S_TOKEN, K8S_CA_CERT
    - mkdir -p ~/.kube
    - |
      cat > ~/.kube/config << EOF
      apiVersion: v1
      kind: Config
      clusters:
      - name: k3s
        cluster:
          server: ${K8S_HOST}
          certificate-authority-data: ${K8S_CA_CERT}
      contexts:
      - name: default
        context:
          cluster: k3s
          user: terraform-ci
      current-context: default
      users:
      - name: terraform-ci
        user:
          token: ${K8S_TOKEN}
      EOF
    - chmod 600 ~/.kube/config

validate:
  extends: .terraform-base
  stage: validate
  script:
    # Format check - no backend required
    - terraform fmt -check -recursive
    # Validate with -backend=false (no credentials needed)
    - terraform init -backend=false
    - terraform validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

plan:
  extends: .terraform-base
  stage: plan
  script:
    - terraform init -backend-config="conn_str=$PG_CONN_STR"
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - tfplan
      - .terraform
      - .terraform.lock.hcl
    expire_in: 1 hour
  rules:
    # Only run on main branch where protected variables are available
    - if: $CI_COMMIT_BRANCH == "main"

apply:
  extends: .terraform-base
  stage: apply
  dependencies:
    - plan
  script:
    - terraform init -backend-config="conn_str=$PG_CONN_STR"
    - terraform apply -auto-approve
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: production
